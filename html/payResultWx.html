<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <title>支付结果</title>
  <link rel="stylesheet" type="text/css" href="../lib/css/weui.min.css" />
  <link rel="stylesheet" type="text/css" href="../lib/css/jquery-weui.css" />
  <link rel="stylesheet" type="text/css" href="../custom/css/common.css" />
  <!--<link rel="stylesheet" type="text/css" href="../custom/css/manage.css" />-->

</head>

<body>
  <div class="popup-wrap" style="display:block;">
    <div class="lightbox"></div>
    <div class="popup-con popup-con-middle">
      <!--<span class="close"></span>-->
      <p class="popup-txt">请确认微信支付是否已完成？</p>
      <div class="popup-btmbtn"><span class="preRepay">重新支付</span><span class="ok">支付已完成</span></div>
    </div>
  </div>
  <div class="container manageContainer">
    <div class="no-data-box" id="ask">
      <div class="custom-nodata">
        <img src="../custom/images/success.png" style="width:3.293333rem;height: 2.88rem;">
      </div>
    </div>
    <div class="no-data-box" style="display:none;" id="success">
      <div class="custom-nodata">
        <img src="../custom/images/success.png" style="width:3.293333rem;height: 2.88rem;">
        <p class="largeTxt">支付成功~</p>
      </div>
      <div class="btn-box">
        <span id="toIndex">返回商城</span><span id="orderDetail">查看订单</span>
      </div>
    </div>
    <div class="no-data-box" style="display:none;" id="fail">
      <div class="custom-nodata">
        <img src="../custom/images/fail.png" style="width:3.293333rem;height: 2.706667rem;">
        <p class="largeTxt">支付失败</p>
      </div>
      <div class="btn-box">
        <span class="repay">重新支付</span>
      </div>
    </div>
  </div>
<script type="text/javascript" src="../lib/js/flexible.js"></script>
<script type="text/javascript" src="../lib/js/fastclick.min.js"></script>
<script type="text/javascript" src="../lib/js/jquery.min.js"></script>
<script src="../lib/js/jquery-weui.js"></script>
<script type="text/javascript" src="../custom/js/native.js"></script>
<script type="text/javascript" src="../custom/js/common.js"></script>
<script type="text/javascript" src="../custom/js/net.js"></script>
<!--<script src="../custom/js/myTips.js"></script>-->
<!--<script src="../custom/js/api.js"></script>-->
<script>
  $(function () {
    //click事件优化
    FastClick.attach(document.body);

    $.toast.prototype.defaults.duration = 800;

    var netToken = localStorage.getItem('netToken');
    var requestUrl = localStorage.getItem('requestUrl');
    var channelCode = localStorage.getItem('channelCode');
    var lightAppCode = localStorage.getItem('lightAppCode');
    var appid = localStorage.getItem('appid');
    var uid = localStorage.getItem('uid');
    var isNative=localStorage.getItem('isNative') || getParams('isNative');

    // var businessNo = localStorage.getItem("businessNo");
    var biz_id = localStorage.getItem('biz_id'), business_no = localStorage.getItem('order_code'), order_code = localStorage.getItem('order_code'),
      pay_amount = localStorage.getItem('pay_amount'), service_meal = localStorage.getItem('service_meal'), biz_name = localStorage.getItem('biz_name');

    $(".ok").on("click", function () {
      getResult();
    });
    $(".preRepay").on("click", function () {
      showMyloading();
      try {
        $.ajax({
          url: net.adQueryPayStatus,
          type: "post",
          contentType: 'application/json',
          beforeSend: function (request) {
            request.setRequestHeader("token", netToken);
            request.setRequestHeader("channelCode", channelCode);
            request.setRequestHeader("lightAppCode", lightAppCode);
            request.setRequestHeader("appid", appid);
            request.setRequestHeader('timestamp', new Date().getTime());
          },
          data: JSON.stringify({
            "biz_id": biz_id,
            "business_no": business_no,
            "uid": uid,
            // "shopUserId":shopUserId
          }),
          success: function (data) {
            // alert(1)
            // alert(typeof data)
            var firstData = JSON.parse(data);
            if (firstData.code == 0) {
              // alert('firstData.code==0')

              if (firstData.data.status == '1') {
                // alert('firstData.data.status ==1')

                // $(".mytip").html("您已支付成功,请勿重复支付");
                $.toast('您已支付成功,请勿重复支付', 'forbidden');
                // showMyTip();
                setTimeout(function () {
                  $(".popup-wrap").hide();
                  $("#ask").hide();
                  $("#success").show();
                },1500)
                hideMyloading();
              } else if ( firstData.data.status == '0') {
                // alert('firstData.data.status ==0')

                NativeFunc({
                  ACTION: "OPENURL",
                  PARAM: {
                    URL: requestUrl + '/orderPay.html?forPage=2&order_code='+order_code+'&service_meal='+service_meal+'&pay_amount='+pay_amount+'&biz_id='+biz_id+'&biz_name='+biz_name
                  }
                });
                hideMyloading();
              }

            } else if (firstData.code == 12) {
              // alert('firstData.code == 12')
              $.toast('账户在其他设备登录,请重新登录', 'forbidden');
              // $(".mytip").html("账户在其他设备登录,请重新登录");
              // showMyTip();
              hideMyloading();
            } else {
              // alert(2)
              $.toast(firstData.msg || "查询支付状态失败", 'forbidden');
              // $(".mytip").html(firstData.msg || "查询支付状态失败");
              // showMyTip();
              hideMyloading();
            }
          },
          error: function (error) {
            // alert(3)
            hideMyloading();
            console.log(error)
            // showMyTip();
          }
        })
      } catch (e) {
        // alert(4)
        hideMyloading();
        // showMyTip();
        console.log(e);
      }
    })
    function getResult() {
      showMyloading();
      try {
        $.ajax({
          url: net.adQueryPayStatus,
          type: "post",
          contentType: 'application/json',
          beforeSend: function (request) {
            request.setRequestHeader("token", netToken);
            request.setRequestHeader("channelCode", channelCode);
            request.setRequestHeader("lightAppCode", lightAppCode);
            request.setRequestHeader("appid", appid);
            request.setRequestHeader('timestamp', new Date().getTime());
          },
          data: JSON.stringify({
            "biz_id": biz_id,
            "business_no": business_no,
            "uid": uid,
            // "shopUserId":shopUserId
          }),
          success: function (data) {
            // alert(1)
            // alert(typeof data)
            // alert(JSON.stringify(data))
            var secondData = JSON.parse(data);
            if (secondData.code == 0) {
              // alert('secondData.code == 0')
              if (secondData.data.status == '1') {
                // alert('secondData.data.status == 1')
                $(".popup-wrap").hide();
                $("#ask").hide();
                $("#success").show();
              } else if ( secondData.data.status == '0') {
                // alert('secondData.data.status == 0')
                $(".popup-wrap").hide();
                $("#ask").hide();
                $("#fail").show();
              }
              hideMyloading();
            } else if (secondData.code == 12) {
              // alert('secondData.code == 12')
              hideMyloading();
              // $(".mytip").html("账户在其他设备登录,请重新登录");
              $.toast('账户在其他设备登录,请重新登录', 'forbidden');
              // showMyTip();
            } else {
              // alert(2)
              hideMyloading();
              $.toast(secondData.msg || "查询支付状态失败", 'forbidden');
              // $(".mytip").html(secondData.msg || "查询支付状态失败");
              // showMyTip();
            }
          },
          error: function (error) {
            // alert(3)

            hideMyloading();
            console.log(error)
            // showMyTip();
          }
        })
      } catch (e) {
        // alert(4)
        hideMyloading();
        // showMyTip();
        console.log(e);
      }
    }

    //跳首页
    $(document).on('click', '#toIndex', function () {
      if(isNative == 1){
        //回到第一个webview
        NativeFunc({
          ACTION: 'CLOSEPAGE',
          PARAM: {
            INDEX: -1
          }
        });
      }else {
        NativeFunc({
          ACTION: "OPENURL",
          PARAM: {
            URL: requestUrl + "/myorderList.html?noFirst=1"
            // URL: localStorage.getItem("indexUrl") + "&noFirst=1"
          }
        })
      }
    });
    //查看订单
    $(document).on('click', '#orderDetail', function () {
      NativeFunc({
        ACTION: "OPENURL",
        PARAM: {
          URL: requestUrl + "/orderDetail.html?pay_code=" + order_code
        }
      })
    });
    //重新支付
    $(document).on('click', '.repay', function () {
      NativeFunc({
        ACTION: "OPENURL",
        PARAM: {
          URL: requestUrl + '/orderPay.html?forPage=2&order_code='+order_code+'&service_meal='+service_meal+'&pay_amount='+pay_amount+'&biz_id='+biz_id+'&biz_name='+biz_name
        }
      })
    });
  })
</script>

</body>

</html>