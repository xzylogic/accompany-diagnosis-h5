<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>服务评价</title>
  <link rel="stylesheet" type="text/css" href="../lib/css/weui.min.css" />
  <link rel="stylesheet" type="text/css" href="../lib/css/jquery-weui.css" />
  <link rel="stylesheet" type="text/css" href="../custom/css/common.css" />
  <link rel="stylesheet" type="text/css" href="../custom/css/main.css" />
  <style>
    .weui-toast--text {
      width: 5.5rem;
    }
  </style>
</head>

<body>
	<div class="container">
    <div class="comment-wrap">
      <div class="user-mes-box">
        <span class="pic"><img src="../custom/images/head_bg.png"></span>
        <div class="con1">
          <h5><span class="name"></span><em></em></h5>
          <p class="p1"></p>
        </div>
      </div>
      <h3>服务评价</h3>
      <div class="comment-box">
        <p class="action-box">
          <span class="expression1" onclick="show(this, 'very-good');return false;">非常满意</span>
          <span class="expression2" onclick="show(this, 'satisfied');return false;">满意</span>
          <span class="expression3" onclick="show(this, 'general');return false;">一般</span>
          <span class="expression4" onclick="show(this, 'yawp');return false;">不满意</span>
        </p>
        <div class="textarea-wrap">
            <textarea class="weui-textarea" placeholder="请输入您的评价" rows="3" maxlength="100"></textarea>
            <div class="weui-textarea-counter"><span id="num">0</span>/100</div>
        </div>
      </div>
    </div>
    <div class="custom-btm-fixed">
        <span class="custom-btm-btn" onclick="evaluateSubmit()">提交评价</span>
    </div>
  </div>
  <script type="text/javascript" src="../lib/js/flexible.js"></script>
  <script type="text/javascript" src="../lib/js/fastclick.min.js"></script>
  <script type="text/javascript" src="../lib/js/jquery.min.js"></script>
  <script src="../lib/js/jquery-weui.js"></script>
  <script src="../custom/js/native.js"></script>
  <script src="../custom/js/net.js"></script>
  <script src="../custom/js/common.js"></script>

  <script>
    $.toast.prototype.defaults.duration = 800;

    var pay_code = getParams('pay_code');
    GetQueryString();

    function GetQueryString() {
      $.ajax({
        type: "GET",
        url: net.orderDetail,
        data: {pay_code: pay_code},
        beforeSend: function (request) {
          showMyloading();
          request.setRequestHeader('token', localStorage.getItem('netToken'));
          request.setRequestHeader('channelCode', localStorage.getItem('channelCode'));
          request.setRequestHeader('lightAppCode', localStorage.getItem('lightAppCode'));
          request.setRequestHeader('appid', localStorage.getItem('appid'));
          request.setRequestHeader('timestamp', new Date().getTime());
        },
        success: function (data) {
          // console.log(data.data)
          hideMyloading();
          var datas = (data.data.reservation_detail && data.data.reservation_detail.accompany_info_dto) || '';
          if (data.code === 0) {
            $('.pic img').attr('src', datas.emp_url || '../custom/images/head_bg.png');
            $('.name').text(datas.emp_name || '');
            $('.con1 em:eq(0)').text(datas.emp_mobile || '');
            $('.p1').text(datas.organization || '');
          }else{
            $.toast(data.msg || '请求错误~', 'text');
          }
        },
        error: function (err) {
          hideMyloading();
          $.toast('网络出错~' , 'text');
          console.log(err);
        }
      });
    }

    var evalueteVal;

    function show(obj, val)
    {
      $('.action-box span').removeClass('active');
      $(obj).addClass('active');
      evalueteVal = val;
    }

    // function wordStatic(input) {
    //     var content = document.getElementById('num');
    //     if (content && input) {
    //         var value = input.value;
    //         value = value.replace(/\n|\r/gi,"");
    //         content .innerText = value.length;
    //     }
    // }
    $('.weui-textarea').bind('input', function () {
      var resonLen = $('.weui-textarea').val().length;
      $('#num').text(resonLen);
    });

    function evaluateSubmit() {
      var textVal = $('.weui-textarea').val();
      if(evalueteVal){
        var reservation_id = getParams('reservation_id') || getParams('pay_code');
        $.ajax({
          type: "POST",
          url: net.adReservationEvaluate,
          data : JSON.stringify({
            satisfied_level : evalueteVal,
            evaluate_content: textVal,
            reservation_id: reservation_id
          }),
          contentType: 'application/json; charset=utf-8',
          beforeSend: function(request) {
            showMyloading();
            request.setRequestHeader('token', localStorage.getItem('netToken'));
            request.setRequestHeader('channelCode', localStorage.getItem('channelCode'));
            request.setRequestHeader('lightAppCode', localStorage.getItem('lightAppCode'));
            request.setRequestHeader('appid', localStorage.getItem('appid'));
            request.setRequestHeader('timestamp', new Date().getTime());
          },
          success: function(data){
            hideMyloading();
            if(data.code === 0){
              NativeFunc({
                ACTION: "OPENURL",
                PARAM:{
                  URL: nativeObj.htmlPath + '/commentDetail.html?reservation_id='+reservation_id
                }
              });
            }else{
              $.toast(data.msg || '请求错误~', 'text');
            }
          },
          error: function (err) {
            hideMyloading();
            console.log(err)
          }
        });
      }else{
        $.toptip('请您对服务进行满意度评分～', 800, 'error');
      }
    }
  </script>
</body>
</html>
