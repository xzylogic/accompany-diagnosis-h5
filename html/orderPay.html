<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="format-detection" content="telephone=no">
  <title>订单支付</title>
  <link rel="stylesheet" type="text/css" href="../lib/css/weui.min.css" />
  <link rel="stylesheet" type="text/css" href="../custom/css/common.css" />
  <link rel="stylesheet" type="text/css" href="../custom/css/main.css" />

</head>

<body>
	<div class="container">
    <div class="order-pay-wrap">
        <div class="title-box">
            <span>1145687254778</span><br /><span>上海健康云陪诊服务中心</span>
        </div>
        <p class="lineBg"></p>
        <div class="total-box">
            <h3>¥<em></em></h3>
            <p><em>全程陪诊服务套餐</em><span></span></p>
        </div>
        <p class="lineBg"></p>
        <div class="pay-way">
          <h5>支付方式</h5>
          <ul class="pay-way-list">
            <li class="payOne">
              <img src="../custom/images/apliy.png">
              <span>支付宝支付</span>
              <label class="custom_check_label">
                  <input type="radio" name="pay" id="radio1" value="1" hidden checked/>
                  <label for="radio1" class="icon-check"></label>
              </label>
            </li>
            <li class="payTwo">
              <img src="../custom/images/wx.png">
              <span>微信支付</span>
              <label class="custom_check_label">
                  <input type="radio" name="pay" id="radio2" value="1" hidden />
                  <label for="radio2" class="icon-check"></label>
              </label>
            </li>
          </ul>
        </div>
    </div>
    <div class="custom-btm-fixed">
        <span class="custom-btm-btn">确认支付</span>
    </div>
  </div>
  <script type="text/javascript" src="../lib/js/flexible.js"></script>
  <script type="text/javascript" src="../lib/js/fastclick.min.js"></script>
  <script type="text/javascript" src="../lib/js/jquery.min.js"></script>
  <script type="text/javascript" src="https://pv.sohu.com/cityjson?ie=utf-8"></script>
  <script src="../lib/js/jquery-weui.js"></script>
  <script src="../custom/js/native.js"></script>
  <script src="../custom/js/common.js"></script>
  <script src="../custom/js/net.js"></script>

  <script>
    // $('.custom-btm-btn').click(function () {
    //   if($('#radio1').is(':checked')){
    //     // console.log(1);
    //     window.location.href = 'payResult.html';
    //   }
    //   if($('#radio2').is(':checked')){
    //     // console.log(2);
    //     window.location.href = 'payResult.html';
    //   }
    // })

    $.toast.prototype.defaults.duration = 800;

    document.querySelector('.payOne').addEventListener('click', function () {
      $('#radio1').prop('checked', true);
    }, false);
    document.querySelector('.payTwo').addEventListener('click', function () {
      $('#radio2').prop('checked', true);
    }, false);

    $(function () {
      var hasWx=true;
      var forPage=getParams("forPage");
      //从我的订单直接进入支付页面，不需要连续关闭两个页面
      if(forPage == '0'){
        //IOS 直接返回一个Webview 无论有多少页内跳转(等ios发布之后注释放开，不然index:100时 ios闪退)
        if(nativeObj.frameType == '0'){
          setTimeout(function () {
            NativeFunc({
              ACTION: "BACKMODE",
              PARAM: {
                INDEX: "100"
              }
            })
          },100);
        }
      } else if(forPage == '2'){
        setTimeout(function () {
          NativeFunc({
            ACTION: "BACKMODE",
            PARAM: {
              INDEX: "2"
            }
          })
        },100);
      }else{
        setTimeout(function () {
          NativeFunc({
            ACTION: "BACKMODE",
            PARAM: {
              INDEX: "1"
            }
          })
        },100);
      }
      setTimeout(function () {
        NativeFunc({
          ACTION: "CHECK_WECHAT_ALIPAY",
          PARAM: {
            MODE: "GET"
          }
        }, function (response) {
          if(response) {
            var objResp = JSON.parse(response);
            if(objResp.wechat == 0){
              hasWx=false;
            }
            // {
            //     wechat:0
            //     alipay:1
            // }
          }
        });
      },100)
      //click事件优化
      FastClick.attach(document.body);

      var requestUrl=nativeObj.htmlPath;
      localStorage.setItem('requestUrl', requestUrl);
      console.log(requestUrl);

      var netToken = localStorage.getItem('netToken');
          // requestUrl= localStorage.getItem('requestUrl');
      var channelCode= localStorage.getItem('channelCode');
      var lightAppCode=localStorage.getItem('lightAppCode');
      var appid=localStorage.getItem('appid');
      var uid= localStorage.getItem('uid');
      //订单金额和订单id
      var order_code=getParams("order_code"),
          service_meal = decodeURIComponent(getParams('service_meal')),
          biz_id = getParams('biz_id'),
          biz_name = decodeURIComponent(getParams('biz_name')),
          pay_amount=getParams("pay_amount");
      // var pay_amount=decodeURIComponent(getParams("pay_amount"));
      console.log(order_code, '----------',pay_amount);
      $(".title-box span:eq(0)").text(order_code);
      $(".title-box span:eq(1)").text(biz_name);
      $(".total-box em:eq(0)").text(pay_amount);
      $(".total-box em:eq(1)").text(service_meal);
      $(".total-box span:eq(0)").text('¥'+pay_amount+'/次');
      // $(".total-box span").html("￥"+pay_amount);
      var newTab;
      //操作系统
      var ua = navigator.userAgent;
      var os;
      if (ua.toLowerCase().indexOf("iphone") > -1||ua.toLowerCase().indexOf("ipad") > -1) {
        os="ios";
      }else{
        os="android";
      }
      //支付宝
      // $("#alipay").on("click",function () {
      //   $("#alipay label")[0].addClass("checkRadio");
      //   $("#wechat label")[0].removeClass("checkRadio");
      // })
      // //微信支付
      // $("#wechat").on("click",function () {
      //   $("#wechat label")[0].addClass("checkRadio");
      //   $("#alipay label")[0].removeClass("checkRadio");
      // })
      //支付
      var checkedWay = '';
      $(".custom-btm-btn").on("click",function (){
        if($('#radio1').is(':checked')){
          console.log(1);
          checkedWay="alipay";
          // window.location.href = 'payResult.html';
        }else if($('#radio2').is(':checked')){
          console.log(2);
          checkedWay="wechat";
          // window.location.href = 'payResult.html';
        }
        if(checkedWay == ""){
          // $(".mytip").html("请选择支付方式");
          $.toast("请选择支付方式", 'forbidden');
          // showMyTip();
          return;
        }
        if(checkedWay == "wechat" && hasWx == false){
          // $(".mytip").html("微信未安装");
          $.toast("微信未安装", 'forbidden');
          // showMyTip();
          return;
        }
        // if($("#alipay label").hasClass("checkRadio")){
        //   checkedWay="alipay"
        // }else if($("#wechat label").hasClass("checkRadio")){
        //   checkedWay="wechat"
        // }

        //调接口创建支付信息
        // newTab=window.open();
        // console.log(newTab)

        var Pro = function () {
          return new Promise(function (resolve, reject) {
            $.ajax({
              url:net.adGetSdkPayParams,
              type:"post",
              async:false,
              timeout: 6000,
              data:JSON.stringify({
                "amount": (Number(pay_amount).toFixed(2))*100,
                "business_no": order_code,
                "biz_name": biz_name,
                "order_name": service_meal,
                "os": os,
                "uid": uid,
                "biz_id": biz_id,
                "pay_channel": checkedWay,
              }),
              contentType: 'application/json; charset=utf-8',
              beforeSend: function(request) {
                showMyloading();
                request.setRequestHeader("token",netToken);
                request.setRequestHeader("channelCode",channelCode);
                request.setRequestHeader("lightAppCode",lightAppCode);
                request.setRequestHeader("appid",appid);
                request.setRequestHeader('timestamp', new Date().getTime());
              },
              success:function(firstData){
                // alert(firstData)
                console.log(firstData);
                firstData = JSON.parse(firstData);
                console.log(firstData);
                if(firstData.code == 0){
                  resolve(firstData);
                  hideMyloading();
                }else{
                  //showMyTip();
                  hideMyloading();
                  // $(".mytip").html(data.msg||"创建支付信息接口出错");
                  $.toast(firstData.msg || "创建支付信息接口出错", 'forbidden');
                }
                // hideMyloading();
              },
              error:function(error){
                //showMyTip();
                hideMyloading();
                // hideMyloading();
                reject('请求错误');
              }
            });
          })
        };

        // var scanConsumeResponse;
        Pro().then(function (firData) {
          var secData = firData.data;
          console.log(firData);
          try {
            $.ajax({
              url:net.payAgent,
              type:"post",
              timeout: 6000,
              beforeSend: function(request) {
                // showMyloading();
                request.setRequestHeader("token",netToken);
                request.setRequestHeader("channelCode",channelCode);
                request.setRequestHeader("lightAppCode",lightAppCode);
                request.setRequestHeader('appid', localStorage.getItem('appid'));
                request.setRequestHeader('timestamp', new Date().getTime());
                // request.setRequestHeader("uid",uid);
              },
              data:JSON.stringify({
                "amount":((Number(pay_amount).toFixed(2))*100).toFixed(0),
                "payType":checkedWay,
                "merchantId":biz_id,//待定字段商户ID
                "businessNo":order_code,//待定字段业务单号
                "uid":uid,
                "clientIp":returnCitySN.cip,
                "os": os,
                "merchantName": secData.subject,//待定字段测试商户
                "subject":service_meal,//待定字段订单名称
                "orderDesc":secData.body,//待定字段订单描述
                "orderItemDesc":secData.description//待定字段商品描述

              }),
              contentType: 'application/json; charset=utf-8',
              success:function(data){
                hideMyloading();
                // alert(data)
                // if(data.code == 0){
                //   scanConsumeResponse = data;
                // }else if(data.code == 12){
                //   $.toast("账户在其他设备登录,请重新登录", 'forbidden');
                //   // $(".mytip").html("账户在其他设备登录,请重新登录");
                //   // //showMyTip();
                // }else{
                //   $.toast(data.msg||"跳转支付失败", 'forbidden');
                //   // $(".mytip").html(data.msg||"跳转支付失败");
                //   // //showMyTip();
                // }

                if(data.code == 0){
                  // localStorage.setItem("businessNo",firstData.data);
                  localStorage.setItem("businessNo", order_code);
                  // localStorage.setItem("pay_amount", pay_amount);
                  if(checkedWay == "alipay"){
                    document.write(data.data);
                  }else{
                    localStorage.setItem("payRes",data.data);
                    NativeFunc({
                      ACTION: "OPENURL",
                      PARAM: {
                        URL: requestUrl +"/blank.html"
                      }
                    })
                  }
                }else if(data.code == 12){
                  // $(".mytip").html("账户在其他设备登录,请重新登录");
                  $.toast("账户在其他设备登录,请重新登录", 'forbidden');

                  //showMyTip();
                }else{
                  // $(".mytip").html(data.msg||"跳转支付失败");
                  $.toast(data.msg || "跳转支付失败", 'forbidden');
                  //showMyTip();
                }
                hideMyloading();
              },
              error:function(error){
                console.log(error)
                //showMyTip();
                hideMyloading();
              }
            })
          } catch (e) {
            hideMyloading();
            // showMyTip();
            console.log(e);
          }

          // if(scanConsumeResponse && scanConsumeResponse.code == 0){
          //   newTab=window.open();
          //   newTab.document.write(scanConsumeResponse.data);
          // }

        });




      })

    })
  </script>
</body>
</html>
